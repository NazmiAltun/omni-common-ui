{"version":3,"sources":["domain/Api/index.js"],"names":["CORS_SIMPLE_METHODS","SECURE_URL_REGEXP","IS_BEARER_TOKEN_IN_URLS_ENABLED","get","buildUrl","path","FetchTimedOutError","Error","ApiError","response","message","statusText","ok","url","type","status","headers","body","fetch","options","string","object","user","getState","accessToken","access_token","finalOptions","Object","assign","getDefaultFetchOpts","finalUrl","test","includes","warn","Promise","resolve","reject","onTimeout","timeout","setTimeout","then","checkResponseStatus","parseResponse","clearTimeout","catch","error","token","isCorsSimpleMethod","empty","falsy","method","toUpperCase","Accept","Authorization","not","undefined","rawResponse","text","JSON","parse","e","apiResponse","keys","forEach","key","Api"],"mappings":"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","file":"index.js","sourcesContent":["import invariant from 'invariant';\nimport isomorphicFetch from 'isomorphic-fetch';\nimport is from 'is_js';\nimport camelCase from 'camelcase';\nimport log from 'domain/log';\nimport Store from 'domain/Store';\nimport Config from 'domain/Config';\n\n// https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS#Simple_requests\nconst CORS_SIMPLE_METHODS = ['GET', 'HEAD'];  // omit POST, we must send a `Content-Type`\nconst SECURE_URL_REGEXP = /^(https:)?\\/\\//;\nconst IS_BEARER_TOKEN_IN_URLS_ENABLED = !! Config.get('includeBearerTokenInApiGetUrls');\n\nexport const buildUrl = (path) => Config.get('apiBase') + path;\n\nclass FetchTimedOutError extends Error { }\n\nexport class ApiError extends Error {\n  constructor(response = {}, message) {\n    super(message || response.statusText);\n    // https://fetch.spec.whatwg.org/#responses\n    this.ok = response.ok;\n    this.url = response.url;\n    this.type = response.type;\n    this.status = response.status;\n    this.statusText = response.statusText;\n    this.headers = response.headers;\n    this.body = response.body;\n  }\n}\n\nexport const fetch = (url, options = {}) => {\n  invariant(is.string(url), 'url must be a string');\n  invariant(is.object(options), 'options must be a plain object');\n\n  const user = Store.get().getState().get('singleSignOn').user || {};\n  const { access_token: accessToken } = user;\n  const finalOptions = Object.assign({}, options, getDefaultFetchOpts(options, accessToken));\n\n  // https://m.alphasights.com/killing-cors-preflight-requests-on-a-react-spa-1f9b04aa5730#4bdf\n  let finalUrl = url;\n  if (IS_BEARER_TOKEN_IN_URLS_ENABLED) {\n    if (SECURE_URL_REGEXP.test(url)) {\n      // eslint-disable-next-line prefer-template\n      finalUrl = url + (url.includes('?') ? '&' : '?') + `bearer_token=${accessToken}`;\n    } else {\n      log.warn('Refusing to append `bearer_token` to a non-secure URL', url);\n    }\n  }\n\n  return new Promise((resolve, reject) => {\n    const onTimeout = () => reject(new FetchTimedOutError(`Call to ${url} has taken too long!`));\n    const timeout = setTimeout(onTimeout, Config.get('fetchTimeout'));\n\n    isomorphicFetch(finalUrl, finalOptions)\n      .then(checkResponseStatus)\n      .then(parseResponse)\n      .then((response) => {\n        clearTimeout(timeout);\n        resolve(response);\n      })\n      .catch((error) => {\n        clearTimeout(timeout);\n        reject(error);\n      });\n  });\n};\n\nfunction getDefaultFetchOpts(options, token) {\n  const isCorsSimpleMethod =\n      is.empty(options) ||\n      is.falsy(options.method) ||\n      (is.string(options.method) &&\n        CORS_SIMPLE_METHODS.includes(options.method.toUpperCase()));\n  return {\n    headers: Object.assign(\n      { Accept: 'application/json; charset=utf-8' },\n      ! IS_BEARER_TOKEN_IN_URLS_ENABLED ? {\n        Authorization: `Bearer ${token}`,\n      } : {},\n      ! isCorsSimpleMethod ? {\n        'Content-Type': 'application/json',\n      } : {},\n      is.not.object(options) ? undefined : options.headers\n    ),\n  };\n}\n\nfunction parseResponse(rawResponse) {\n  return rawResponse.text()\n      .then((response) => {\n        try {\n          return JSON.parse(response);\n        } catch (e) {\n          return response;\n        }\n      });\n}\n\nfunction checkResponseStatus(response) {\n  if (response.ok) {\n    return response;\n  }\n\n  const error = new ApiError(response);\n  try {\n    return parseResponse(response)\n        .then((apiResponse) => {\n          if (is.not.object(apiResponse)) {\n            error.response = apiResponse;\n          } else {\n            error.response = {};\n            Object.keys(apiResponse).forEach((key) => {\n              error.response[camelCase(key)] = apiResponse[key];\n            });\n          }\n\n          throw error;\n        });\n  } catch (e) {\n    throw error;\n  }\n}\n\nclass Api { }\n\nApi.fetch = fetch;\nApi.buildUrl = buildUrl;\n\nexport default Api;\n"]}