{"version":3,"sources":["domain/Api/index.js"],"names":["CORS_SIMPLE_METHODS","buildUrl","path","get","FetchTimedOutError","Error","ApiError","response","message","statusText","ok","url","type","status","headers","body","fetch","options","string","object","user","getState","finalOptions","Object","assign","getDefaultFetchOpts","finalUrl","startsWith","includes","access_token","warn","Promise","resolve","reject","onTimeout","timeout","setTimeout","then","checkResponseStatus","parseResponse","clearTimeout","catch","error","isCorsSimpleMethod","empty","falsy","method","toUpperCase","Accept","not","undefined","rawResponse","text","JSON","parse","e","apiResponse","keys","forEach","key","Api"],"mappings":"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","file":"index.js","sourcesContent":["import invariant from 'invariant';\nimport isomorphicFetch from 'isomorphic-fetch';\nimport is from 'is_js';\nimport log from 'domain/log';\nimport Store from 'domain/Store';\nimport camelCase from 'camelcase';\nimport Config from 'domain/Config';\n\n// https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS#Simple_requests\nconst CORS_SIMPLE_METHODS = ['GET', 'HEAD'];  // omit POST, we must send a `Content-Type`\n\nexport const buildUrl = (path) => Config.get('apiBase') + path;\n\nclass FetchTimedOutError extends Error { }\n\nexport class ApiError extends Error {\n  constructor(response = {}, message) {\n    super(message || response.statusText);\n    // https://fetch.spec.whatwg.org/#responses\n    this.ok = response.ok;\n    this.url = response.url;\n    this.type = response.type;\n    this.status = response.status;\n    this.statusText = response.statusText;\n    this.headers = response.headers;\n    this.body = response.body;\n  }\n}\n\nexport const fetch = (url, options = {}) => {\n  invariant(is.string(url), 'url must be a string');\n  invariant(is.object(options), 'options must be a plain object');\n\n  const user = Store.get().getState().get('singleSignOn').user || {};\n  const finalOptions = Object.assign({}, options, getDefaultFetchOpts(options));\n\n  // https://m.alphasights.com/killing-cors-preflight-requests-on-a-react-spa-1f9b04aa5730#4bdf\n  let finalUrl = url;\n  if (url.startsWith('https:')) {\n    // eslint-disable-next-line prefer-template\n    finalUrl = url + (url.includes('?') ? '&' : '?') + `bearer_token=${user.access_token}`;\n  } else {\n    log.warn('Refusing to append `bearer_token` to a non-secure URL', url);\n  }\n\n  return new Promise((resolve, reject) => {\n    const onTimeout = () => reject(new FetchTimedOutError(`Call to ${url} has taken too long!`));\n    const timeout = setTimeout(onTimeout, Config.get('fetchTimeout'));\n\n    isomorphicFetch(finalUrl, finalOptions)\n      .then(checkResponseStatus)\n      .then(parseResponse)\n      .then((response) => {\n        clearTimeout(timeout);\n        resolve(response);\n      })\n      .catch((error) => {\n        clearTimeout(timeout);\n        reject(error);\n      });\n  });\n};\n\nfunction getDefaultFetchOpts(options) {\n  const isCorsSimpleMethod =\n      is.empty(options) ||\n      is.falsy(options.method) ||\n      (is.string(options.method) &&\n        CORS_SIMPLE_METHODS.includes(options.method.toUpperCase()));\n  return {\n    headers: Object.assign(\n      { Accept: 'application/json; charset=utf-8' },\n      ! isCorsSimpleMethod ? {\n        'Content-Type': 'application/json',\n      } : {},\n      is.not.object(options) ? undefined : options.headers\n    ),\n  };\n}\n\nfunction parseResponse(rawResponse) {\n  return rawResponse.text()\n      .then((response) => {\n        try {\n          return JSON.parse(response);\n        } catch (e) {\n          return response;\n        }\n      });\n}\n\nfunction checkResponseStatus(response) {\n  if (response.ok) {\n    return response;\n  }\n\n  const error = new ApiError(response);\n  try {\n    return parseResponse(response)\n        .then((apiResponse) => {\n          if (is.not.object(apiResponse)) {\n            error.response = apiResponse;\n          } else {\n            error.response = {};\n            Object.keys(apiResponse).forEach((key) => {\n              error.response[camelCase(key)] = apiResponse[key];\n            });\n          }\n\n          throw error;\n        });\n  } catch (e) {\n    throw error;\n  }\n}\n\nclass Api { }\n\nApi.fetch = fetch;\nApi.buildUrl = buildUrl;\n\nexport default Api;\n"]}