{"version":3,"sources":["containers/ErrorPageHandler/index.jsx"],"names":["mapStateToProps","ErrorPageHandler","props","_setLastUrlPath","bind","_shouldShowPopUp","_buildMessage","_cleanErrors","_renderChildren","_renderError","nextPath","location","pathname","sessionStorage","lastUrlPath","search","erroredApi","get","error","response","status","object","message","for","errorCode","not","array","args","forEach","arg","replace","erroredApis","clean","api","id","children","config","forceSignoutRedirect","Error","propTypes","shape","size","string","func","first","number","any","isRequired","node","state","routes","getApiErrors","getApiError","mapDispatchToProps","dispatch","key","getErrors","toList","undefined"],"mappings":"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","file":"index.js","sourcesContent":["import styles from './style.postcss';\n\nimport React, { PureComponent } from 'react';\nimport PropTypes from 'prop-types';\nimport is from 'is_js';\nimport ErrorPage from 'components/ErrorPage';\nimport connect from 'domain/connect';\nimport ApiCall from 'containers/ApiCalls';\nimport ErrorPageConfig from 'domain/ErrorPageConfig';\nimport AlertDialog from 'components/AlertDialog';\nimport ErrorMessage from 'domain/ErrorMessage';\nimport Config from 'domain/Config';\nimport userManager from 'containers/SingleSignOn/userManager';\n\nexport class ErrorPageHandler extends PureComponent {\n  constructor(props) {\n    super(props);\n    this._setLastUrlPath = this._setLastUrlPath.bind(this);\n    this._shouldShowPopUp = this._shouldShowPopUp.bind(this);\n    this._buildMessage = this._buildMessage.bind(this);\n    this._cleanErrors = this._cleanErrors.bind(this);\n    this._renderChildren = this._renderChildren.bind(this);\n    this._renderError = this._renderError.bind(this);\n  }\n\n  componentWillUpdate({ location: { pathname: nextPath } }) {\n    const { location: { pathname } } = this.props;\n    if (pathname !== nextPath) {  // page changed, clear errors\n      this._cleanErrors();\n    }\n  }\n\n  _setLastUrlPath() {\n    sessionStorage.lastUrlPath = location.pathname + location.search;\n  }\n\n  _shouldShowPopUp() {\n    const { erroredApi } = this.props;\n\n    if (Config.get('errorHandlerRendersPopUps') !== true || ! erroredApi) {\n      return false;\n    }\n\n    const { response, status } = erroredApi.error;\n    return is.object(response) && status !== 500;\n  }\n\n  _buildMessage() {\n    const { erroredApi: { error: { response } } } = this.props;\n\n    let message = ErrorMessage.for(response.errorCode) || response.message;\n\n    // To handle the pattern of exception response from the end point of identity server\n    // which return { error: string }\n    if (! message && response.error) {\n      message = response.error;\n      return message;\n    }\n\n    if (is.not.array(response.args)) {\n      return message;\n    }\n\n    response.args.forEach((arg) => {\n      message = message.replace(/{\".*\"}/i, arg);\n    });\n\n    return message;\n  }\n\n  _cleanErrors() {\n    const { erroredApis, clean } = this.props;\n    erroredApis.forEach((api) => clean(api.id));\n  }\n\n  _renderChildren() {\n    const { erroredApi, children } = this.props;\n\n    if (erroredApi && ! this._shouldShowPopUp()) {\n      return null; // Because the error page will be rendered.\n    }\n\n    return children;\n  }\n\n  _renderError() {\n    const { erroredApi, config } = this.props;\n\n    if (! erroredApi) {\n      return null;\n    }\n\n    if (erroredApi.error && erroredApi.error.status === 401) {\n      this._setLastUrlPath();\n      userManager.forceSignoutRedirect();\n      throw new Error('Api called with 401 unauthorized');\n    }\n\n    if (this._shouldShowPopUp()) {\n      return <AlertDialog isWarning\n          content1={this._buildMessage()}\n          okButtonContent=\"OK\"\n          onButtonClick={this._cleanErrors} />;\n    }\n\n    return <ErrorPage erroredApi={erroredApi}\n        config={config}\n        {...this.props} />;\n  }\n\n  render() {\n    return <div className={styles.ErrorPageHandler}>\n      {this._renderError()}\n      {this._renderChildren()}\n    </div>;\n  }\n}\n\nErrorPageHandler.propTypes = {\n  config: PropTypes.object,\n  erroredApis: PropTypes.shape({\n    size: PropTypes.string.func,\n    first: PropTypes.string.func,\n    forEach: PropTypes.string.func,\n  }),\n  erroredApi: PropTypes.shape({\n    error: PropTypes.shape({\n      status: PropTypes.number,\n      response: PropTypes.any,\n    }),\n  }),\n  location: PropTypes.shape({\n    pathname: PropTypes.string.isRequired,\n  }).isRequired,\n  clean: PropTypes.func.isRequired,\n  replace: PropTypes.func.isRequired,\n  children: PropTypes.node,\n};\n\nexport function mapStateToProps(state, { routes }) {\n  const erroredApis = getApiErrors(state);\n  const erroredApi = getApiError(erroredApis);\n  return { erroredApis, erroredApi, config: ErrorPageConfig.get(routes) };\n}\n\nfunction mapDispatchToProps(dispatch) {\n  return { clean: (key) => dispatch(ApiCall.clean(key)) };\n}\n\nfunction getApiErrors(state) {\n  return ApiCall.getErrors(state).toList();\n}\n\nfunction getApiError(erroredApis) {\n  if (erroredApis.size <= 0) {\n    return undefined;\n  }\n\n  return erroredApis.first();\n}\n\nexport default connect(mapStateToProps, mapDispatchToProps)(ErrorPageHandler);\n"]}