{"version":3,"sources":["containers/ErrorPageHandler/index.jsx"],"names":["mapStateToProps","ErrorPageHandler","props","_shouldShowPopUp","bind","_buildMessage","_cleanErrors","_renderChildren","_renderError","nextPath","location","pathname","erroredApi","get","error","response","status","object","message","for","errorCode","not","array","args","forEach","arg","replace","erroredApis","clean","api","id","children","config","triggerSignOutRedirect","Error","propTypes","shape","size","string","func","first","number","any","isRequired","node","state","routes","getApiErrors","getApiError","mapDispatchToProps","dispatch","Object","assign","key","getErrors","toList","undefined"],"mappings":";;;;;;;;;;;QAuIgBA,e,GAAAA,e;;AAvIhB;;;;AAEA;;;;AACA;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;;;IAEaC,gB,WAAAA,gB;;;AACX,4BAAYC,KAAZ,EAAmB;AAAA;;AAAA,oIACXA,KADW;;AAEjB,UAAKC,gBAAL,GAAwB,MAAKA,gBAAL,CAAsBC,IAAtB,OAAxB;AACA,UAAKC,aAAL,GAAqB,MAAKA,aAAL,CAAmBD,IAAnB,OAArB;AACA,UAAKE,YAAL,GAAoB,MAAKA,YAAL,CAAkBF,IAAlB,OAApB;AACA,UAAKG,eAAL,GAAuB,MAAKA,eAAL,CAAqBH,IAArB,OAAvB;AACA,UAAKI,YAAL,GAAoB,MAAKA,YAAL,CAAkBJ,IAAlB,OAApB;AANiB;AAOlB;;;;8CAEyD;AAAA,UAAdK,QAAc,QAApCC,QAAoC,CAAxBC,QAAwB;AAAA,UACpCA,QADoC,GACrB,KAAKT,KADgB,CAChDQ,QADgD,CACpCC,QADoC;;AAExD,UAAIA,aAAaF,QAAjB,EAA2B;AAAG;AAC5B,aAAKH,YAAL;AACD;AACF;;;uCAEkB;AAAA,UACTM,UADS,GACM,KAAKV,KADX,CACTU,UADS;;;AAGjB,UAAI,iBAAOC,GAAP,CAAW,2BAAX,MAA4C,IAA5C,IAAoD,CAAED,UAA1D,EAAsE;AACpE,eAAO,KAAP;AACD;;AALgB,8BAOYA,WAAWE,KAPvB;AAAA,UAOTC,QAPS,qBAOTA,QAPS;AAAA,UAOCC,MAPD,qBAOCA,MAPD;;AAQjB,aAAO,gBAAGC,MAAH,CAAUF,QAAV,KAAuBC,WAAW,GAAzC;AACD;;;oCAEe;AAAA,UACiBD,QADjB,GACkC,KAAKb,KADvC,CACNU,UADM,CACQE,KADR,CACiBC,QADjB;;;AAGd,UAAIG,UAAU,uBAAaC,GAAb,CAAiBJ,SAASK,SAA1B,KAAwCL,SAASG,OAA/D;;AAEA;AACA;AACA,UAAI,CAAEA,OAAF,IAAaH,SAASD,KAA1B,EAAiC;AAC/BI,kBAAUH,SAASD,KAAnB;AACA,eAAOI,OAAP;AACD;;AAED,UAAI,gBAAGG,GAAH,CAAOC,KAAP,CAAaP,SAASQ,IAAtB,CAAJ,EAAiC;AAC/B,eAAOL,OAAP;AACD;;AAEDH,eAASQ,IAAT,CAAcC,OAAd,CAAsB,UAACC,GAAD,EAAS;AAC7BP,kBAAUA,QAAQQ,OAAR,CAAgB,SAAhB,EAA2BD,GAA3B,CAAV;AACD,OAFD;;AAIA,aAAOP,OAAP;AACD;;;mCAEc;AAAA,mBACkB,KAAKhB,KADvB;AAAA,UACLyB,WADK,UACLA,WADK;AAAA,UACQC,KADR,UACQA,KADR;;AAEbD,kBAAYH,OAAZ,CAAoB,UAACK,GAAD;AAAA,eAASD,MAAMC,IAAIC,EAAV,CAAT;AAAA,OAApB;AACD;;;sCAEiB;AAAA,oBACiB,KAAK5B,KADtB;AAAA,UACRU,UADQ,WACRA,UADQ;AAAA,UACImB,QADJ,WACIA,QADJ;;;AAGhB,UAAInB,cAAc,CAAE,KAAKT,gBAAL,EAApB,EAA6C;AAC3C,eAAO,IAAP,CAD2C,CAC9B;AACd;;AAED,aAAO4B,QAAP;AACD;;;mCAEc;AAAA,oBACkB,KAAK7B,KADvB;AAAA,UACLU,UADK,WACLA,UADK;AAAA,UACOoB,MADP,WACOA,MADP;;;AAGb,UAAI,CAAEpB,UAAN,EAAkB;AAChB,eAAO,IAAP;AACD;;AAED,UAAIA,WAAWE,KAAX,IAAoBF,WAAWE,KAAX,CAAiBE,MAAjB,KAA4B,GAApD,EAAyD;AACvD,aAAKd,KAAL,CAAW+B,sBAAX,CAAkC,GAAlC,EADuD,CACd;AACzC,cAAM,IAAIC,KAAJ,CAAU,kCAAV,CAAN;AACD;;AAED,UAAI,KAAK/B,gBAAL,EAAJ,EAA6B;AAC3B,eAAO,uDAAa,eAAb;AACH,oBAAU,KAAKE,aAAL,EADP;AAEH,2BAAgB,IAFb;AAGH,yBAAe,KAAKC,YAHjB,GAAP;AAID;;AAED,aAAO,8DAAW,YAAYM,UAAvB;AACH,gBAAQoB;AADL,SAEC,KAAK9B,KAFN,EAAP;AAGD;;;6BAEQ;AACP,aAAO;AAAA;AAAA,UAAK,WAAW,gBAAOD,gBAAvB;AACJ,aAAKO,YAAL,EADI;AAEJ,aAAKD,eAAL;AAFI,OAAP;AAID;;;;;;AAGHN,iBAAiBkC,SAAjB,GAA6B;AAC3BH,UAAQ,oBAAUf,MADS;AAE3BU,eAAa,oBAAUS,KAAV,CAAgB;AAC3BC,UAAM,oBAAUC,MAAV,CAAiBC,IADI;AAE3BC,WAAO,oBAAUF,MAAV,CAAiBC,IAFG;AAG3Bf,aAAS,oBAAUc,MAAV,CAAiBC;AAHC,GAAhB,CAFc;AAO3B3B,cAAY,oBAAUwB,KAAV,CAAgB;AAC1BtB,WAAO,oBAAUsB,KAAV,CAAgB;AACrBpB,cAAQ,oBAAUyB,MADG;AAErB1B,gBAAU,oBAAU2B;AAFC,KAAhB;AADmB,GAAhB,CAPe;AAa3BhC,YAAU,oBAAU0B,KAAV,CAAgB;AACxBzB,cAAU,oBAAU2B,MAAV,CAAiBK;AADH,GAAhB,EAEPA,UAfwB;AAgB3Bf,SAAO,oBAAUW,IAAV,CAAeI,UAhBK;AAiB3BjB,WAAS,oBAAUa,IAAV,CAAeI,UAjBG;AAkB3BZ,YAAU,oBAAUa,IAlBO;AAmB3BX,0BAAwB,oBAAUM,IAAV,CAAeI;AAnBZ,CAA7B;;AAsBO,SAAS3C,eAAT,CAAyB6C,KAAzB,SAA4C;AAAA,MAAVC,MAAU,SAAVA,MAAU;;AACjD,MAAMnB,cAAcoB,aAAaF,KAAb,CAApB;AACA,MAAMjC,aAAaoC,YAAYrB,WAAZ,CAAnB;AACA,SAAO,EAAEA,wBAAF,EAAef,sBAAf,EAA2BoB,QAAQ,0BAAgBnB,GAAhB,CAAoBiC,MAApB,CAAnC,EAAP;AACD;;AAED,SAASG,kBAAT,CAA4BC,QAA5B,EAAsC;AACpC,SAAOC,OAAOC,MAAP,CACH,EAAExB,OAAO,eAACyB,GAAD;AAAA,aAASH,SAAS,mBAAQtB,KAAR,CAAcyB,GAAd,CAAT,CAAT;AAAA,KAAT,EADG,EAEH,sDAA+BH,QAA/B,CAFG,CAAP;AAGD;;AAED,SAASH,YAAT,CAAsBF,KAAtB,EAA6B;AAC3B,SAAO,mBAAQS,SAAR,CAAkBT,KAAlB,EAAyBU,MAAzB,EAAP;AACD;;AAED,SAASP,WAAT,CAAqBrB,WAArB,EAAkC;AAChC,MAAIA,YAAYU,IAAZ,IAAoB,CAAxB,EAA2B;AACzB,WAAOmB,SAAP;AACD;;AAED,SAAO7B,YAAYa,KAAZ,EAAP;AACD;;kBAEc,uBAAQxC,eAAR,EAAyBiD,kBAAzB,EAA6ChD,gBAA7C,C","file":"index.js","sourcesContent":["import styles from './style.postcss';\n\nimport React, { PureComponent } from 'react';\nimport { bindActionCreators } from 'redux';\nimport PropTypes from 'prop-types';\nimport is from 'is_js';\nimport ErrorPage from 'components/ErrorPage';\nimport connect from 'domain/connect';\nimport ApiCall from 'containers/ApiCalls';\nimport ErrorPageConfig from 'domain/ErrorPageConfig';\nimport AlertDialog from 'components/AlertDialog';\nimport ErrorMessage from 'domain/ErrorMessage';\nimport Config from 'domain/Config';\nimport { actions as ssoActions } from 'data/SingleSignOn';\n\nexport class ErrorPageHandler extends PureComponent {\n  constructor(props) {\n    super(props);\n    this._shouldShowPopUp = this._shouldShowPopUp.bind(this);\n    this._buildMessage = this._buildMessage.bind(this);\n    this._cleanErrors = this._cleanErrors.bind(this);\n    this._renderChildren = this._renderChildren.bind(this);\n    this._renderError = this._renderError.bind(this);\n  }\n\n  componentWillUpdate({ location: { pathname: nextPath } }) {\n    const { location: { pathname } } = this.props;\n    if (pathname !== nextPath) {  // page changed, clear errors\n      this._cleanErrors();\n    }\n  }\n\n  _shouldShowPopUp() {\n    const { erroredApi } = this.props;\n\n    if (Config.get('errorHandlerRendersPopUps') !== true || ! erroredApi) {\n      return false;\n    }\n\n    const { response, status } = erroredApi.error;\n    return is.object(response) && status !== 500;\n  }\n\n  _buildMessage() {\n    const { erroredApi: { error: { response } } } = this.props;\n\n    let message = ErrorMessage.for(response.errorCode) || response.message;\n\n    // To handle the pattern of exception response from the end point of identity server\n    // which return { error: string }\n    if (! message && response.error) {\n      message = response.error;\n      return message;\n    }\n\n    if (is.not.array(response.args)) {\n      return message;\n    }\n\n    response.args.forEach((arg) => {\n      message = message.replace(/{\".*\"}/i, arg);\n    });\n\n    return message;\n  }\n\n  _cleanErrors() {\n    const { erroredApis, clean } = this.props;\n    erroredApis.forEach((api) => clean(api.id));\n  }\n\n  _renderChildren() {\n    const { erroredApi, children } = this.props;\n\n    if (erroredApi && ! this._shouldShowPopUp()) {\n      return null; // Because the error page will be rendered.\n    }\n\n    return children;\n  }\n\n  _renderError() {\n    const { erroredApi, config } = this.props;\n\n    if (! erroredApi) {\n      return null;\n    }\n\n    if (erroredApi.error && erroredApi.error.status === 401) {\n      this.props.triggerSignOutRedirect('/');  // return to / to prevent an infinite loop\n      throw new Error('Api called with 401 unauthorized');\n    }\n\n    if (this._shouldShowPopUp()) {\n      return <AlertDialog isWarning\n          content1={this._buildMessage()}\n          okButtonContent=\"OK\"\n          onButtonClick={this._cleanErrors} />;\n    }\n\n    return <ErrorPage erroredApi={erroredApi}\n        config={config}\n        {...this.props} />;\n  }\n\n  render() {\n    return <div className={styles.ErrorPageHandler}>\n      {this._renderError()}\n      {this._renderChildren()}\n    </div>;\n  }\n}\n\nErrorPageHandler.propTypes = {\n  config: PropTypes.object,\n  erroredApis: PropTypes.shape({\n    size: PropTypes.string.func,\n    first: PropTypes.string.func,\n    forEach: PropTypes.string.func,\n  }),\n  erroredApi: PropTypes.shape({\n    error: PropTypes.shape({\n      status: PropTypes.number,\n      response: PropTypes.any,\n    }),\n  }),\n  location: PropTypes.shape({\n    pathname: PropTypes.string.isRequired,\n  }).isRequired,\n  clean: PropTypes.func.isRequired,\n  replace: PropTypes.func.isRequired,\n  children: PropTypes.node,\n  triggerSignOutRedirect: PropTypes.func.isRequired,\n};\n\nexport function mapStateToProps(state, { routes }) {\n  const erroredApis = getApiErrors(state);\n  const erroredApi = getApiError(erroredApis);\n  return { erroredApis, erroredApi, config: ErrorPageConfig.get(routes) };\n}\n\nfunction mapDispatchToProps(dispatch) {\n  return Object.assign(\n      { clean: (key) => dispatch(ApiCall.clean(key)) },\n      bindActionCreators(ssoActions, dispatch));\n}\n\nfunction getApiErrors(state) {\n  return ApiCall.getErrors(state).toList();\n}\n\nfunction getApiError(erroredApis) {\n  if (erroredApis.size <= 0) {\n    return undefined;\n  }\n\n  return erroredApis.first();\n}\n\nexport default connect(mapStateToProps, mapDispatchToProps)(ErrorPageHandler);\n"]}