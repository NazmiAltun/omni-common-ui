{"version":3,"sources":["containers/AuthorizationHandler/index.jsx"],"names":["mapStateToProps","AuthorizationHandler","props","user","permissionChecks","children","havePrivilegesLoaded","spinner","get","profile","userId","sub","email","set","setUserContext","id","debug","fetchPrivilegesIfNeeded","undefined","forbiddenRoute","find","canAccess","propTypes","shape","function","arrayOf","func","isRequired","node","state","routes","filter","route","not","existy","PRODUCTION","Error","config","mapDispatchToProps","dispatch"],"mappings":"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","file":"index.js","sourcesContent":["import React from 'react';\nimport ReactGA from 'react-ga';\nimport PropTypes from 'prop-types';\nimport pure from 'recompose/pure';\nimport Raven from 'raven-js';\nimport connect from 'domain/connect';\nimport is from 'is_js';\nimport { actions as privilegesActions } from 'containers/Privileges';\nimport { bindActionCreators } from 'redux';\nimport AuthorisationErrorPage from 'components/AuthorisationErrorPage';\nimport ErrorPageConfig from 'domain/ErrorPageConfig';\nimport Config from 'domain/Config';\nimport log from 'domain/log';\n\nexport const AuthorizationHandler = (props) => {\n  const { user, permissionChecks, children, havePrivilegesLoaded } = props;\n\n  const spinner = <div className=\"pace\">\n    <div className=\"pace-activity\" />\n  </div>;\n\n  if (Config.get('featureLogin')) {\n    if (! user) {\n      return spinner;\n    }\n    const profile = user.get('profile');\n    const userId = profile.sub;\n    const email = profile.email;\n\n    ReactGA.set({ userId });\n    Raven.setUserContext({ email, id: userId });\n  } else {\n    return children;\n  }\n\n  if (! havePrivilegesLoaded()) {\n    log.debug('PermissionHandler - Will call fetchPrivilegesIfNeeded()');\n    props.fetchPrivilegesIfNeeded();\n    return spinner;\n  }\n\n  if (is.undefined(permissionChecks)) {\n    return children;\n  }\n\n  const forbiddenRoute = permissionChecks.find(({ canAccess }) => ! canAccess(props));\n  if (is.undefined(forbiddenRoute)) {\n    return children;\n  }\n\n  return <AuthorisationErrorPage {...props} />;\n};\n\nAuthorizationHandler.propTypes = {\n  user: PropTypes.shape({\n    get: PropTypes.function,\n  }),\n  permissionChecks: PropTypes.arrayOf(PropTypes.shape({\n    canAccess: PropTypes.func.isRequired,\n  })),\n  children: PropTypes.node,\n  havePrivilegesLoaded: PropTypes.func.isRequired,\n  fetchPrivilegesIfNeeded: PropTypes.func.isRequired,\n};\n\nexport function mapStateToProps(state, { routes }) {\n  const user = state.get('singleSignOn').get('user');\n  const permissionChecks = routes.filter((route) => {\n    if (is.not.existy(route.canAccess)) {\n      return false;\n    }\n\n    if (! PRODUCTION) {\n      if (is.not.function(route.canAccess)) {\n        throw new Error('canAccess in the route configuration should be a function');\n      }\n    }\n\n    return true;\n  });\n\n  return { user, permissionChecks, config: ErrorPageConfig.get(routes) };\n}\n\nfunction mapDispatchToProps(dispatch) {\n  return bindActionCreators(privilegesActions, dispatch);\n}\n\nexport default connect(mapStateToProps, mapDispatchToProps)(pure(AuthorizationHandler));\n"]}