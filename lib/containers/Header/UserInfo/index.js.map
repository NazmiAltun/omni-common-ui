{"version":3,"sources":["containers/Header/UserInfo/index.jsx"],"names":["require","LOGOUT_POPUP_TITLE","LOGOUT_POPUP_MSG","UserInfo","props","state","isDropdownOpen","isShowImpersonate","_checkImpersonation","hasImpersonateFailed","setState","hasUnimpersonated","triggerSignInRedirect","event","preventDefault","confirm","setting","movable","transition","labels","ok","cancel","message","title","onok","router","setRouteLeaveHook","_getCurrentRoute","triggerSignOutRedirect","show","routes","length","postImpersonate","undefined","token","impersonateData","evt","stopPropagation","_closeImpersonateDialog","_handleImpersonateSuccess","canImpersonate","impersonate","_onSwitchBackClicked","_showImpersonateDialog","UserInfo_features","_renderImpersonateOption","_onLogoutButtonClicked","classes","UserInfo_container_user_img","user","get","avatar_url","gender","given_name","family_name","__impersonated","avatarUrl","givenName","familyName","havePrivilegesLoaded","__impersonating","__open","UserInfo_container","e","_toggleDropdown","UserInfo_container_expand","UserInfo_container_user","_renderUser","_renderImpersonatedUser","_renderDropdown","_renderImpersonateDialog","propTypes","any","isRequired","array","func","string","object","privileges","bool","mapStateToProps","postedImpersonate","arePrivilegesLoaded","items","hasPrivilege","mapDispatchToProps","dispatch","Object","assign"],"mappings":"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","file":"index.js","sourcesContent":["import styles from './style.postcss';\n\nimport React, { PureComponent } from 'react';\nimport { bindActionCreators } from 'redux';\nimport classnames from 'classnames';\nimport connect from 'domain/connect';\nimport Dialog from 'components/Dialog';\nimport Impersonate, { actions as impersonateActions } from 'containers/Impersonate';\nimport { actions as ssoActions } from 'data/SingleSignOn';\nimport alertifyjs from 'alertifyjs';\nimport Config from 'domain/Config';\nimport AdultPicture from 'components/AdultPicture';\nimport testClass from 'domain/testClass';\nimport DropdownBox from 'components/DropdownBox';\nimport PrivilegeChecker from 'domain/PrivilegeChecker';\nimport { actions as privilegesActions } from 'containers/Privileges';\nimport Icon from 'components/Icon';\nimport PropTypes from 'prop-types';\n\nrequire('alertifyjs/build/css/alertify.css');\n\nconst LOGOUT_POPUP_TITLE =\n    'Log out';\nconst LOGOUT_POPUP_MSG =\n    'Are you sure you want to leave this page and lose unsaved changes?';\n\nclass UserInfo extends PureComponent {\n  constructor(props) {\n    super(props);\n    this.state = {\n      isDropdownOpen: false,\n      isShowImpersonate: false,\n    };\n    this._checkImpersonation(this.props);\n  }\n\n  componentWillReceiveProps(props) {\n    this._checkImpersonation(props);\n\n    if (props.hasImpersonateFailed) {\n      this.setState({ isShowImpersonate: false });\n    }\n  }\n\n  _checkImpersonation(props) {\n    if (props.hasUnimpersonated) {\n      this.props.triggerSignInRedirect();\n    }\n  }\n\n  _onLogoutButtonClicked() {\n    event.preventDefault();\n    alertifyjs.confirm()\n    .setting({\n      movable: false,\n      transition: 'fade',\n      labels: {\n        ok: 'Leave',\n        cancel: 'Stay',\n      },\n      message: LOGOUT_POPUP_MSG,\n      title: LOGOUT_POPUP_TITLE,\n      onok: () => {\n        // don't show the unsaved changes warning\n        if (this.props.router) {\n          this.props.router.setRouteLeaveHook(this._getCurrentRoute(), null);\n        }\n        this.props.triggerSignOutRedirect();\n      },\n    }).show();\n  }\n\n  _getCurrentRoute() {\n    return this.props.routes[this.props.routes.length - 1];\n  }\n\n  _onSwitchBackClicked() {\n    this.props.postImpersonate(undefined, this.props.token);\n    this.setState({ impersonateData: undefined });\n  }\n\n  _toggleDropdown(evt) {\n    evt.preventDefault();\n    evt.stopPropagation();\n    this.setState({ isDropdownOpen: ! this.state.isDropdownOpen });\n  }\n\n  _showImpersonateDialog() {\n    this.setState({ isShowImpersonate: true, isDropdownOpen: false });\n  }\n\n  _closeImpersonateDialog() {\n    this.setState({ isShowImpersonate: false });\n  }\n\n  _handleImpersonateSuccess() {\n    this.props.triggerSignInRedirect();\n  }\n\n  _renderImpersonateDialog() {\n    if (! this.state.isShowImpersonate) {\n      return null;\n    }\n\n    return <Dialog isOpen={this.state.isShowImpersonate} className={testClass('impersonate-dialog')}>\n      <Impersonate close={() => this._closeImpersonateDialog()}\n          success={() => this._handleImpersonateSuccess()} />\n    </Dialog>;\n  }\n\n  _renderImpersonateOption() {\n    const { canImpersonate } = this.props;\n    if (this.props.impersonate) {\n      return <DropdownBox.Item className={testClass('header-user-dropdown-switch-back')}\n          onClick={() => this._onSwitchBackClicked()}>\n        Switch Back\n      </DropdownBox.Item>;\n    }\n\n    return <DropdownBox.Item className={testClass('header-user-dropdown-switch-user')}\n        onClick={() => this._showImpersonateDialog()}\n        show={canImpersonate}>\n      Switch User\n    </DropdownBox.Item>;\n  }\n\n  _renderDropdown() {\n    return <DropdownBox className={styles.UserInfo_features} open={this.state.isDropdownOpen}>\n      {this._renderImpersonateOption()}\n      <DropdownBox.Item onClick={() => this._onLogoutButtonClicked()}>Log Out</DropdownBox.Item>\n    </DropdownBox>;\n  }\n\n  _renderUser() {\n    const classes = classnames(styles.UserInfo_container_user_img, testClass('user-picture'));\n    return <AdultPicture className={classes}\n        src={this.props.user.get('profile').avatar_url}\n        gender={this.props.user.get('profile').gender}\n        userFirstName={this.props.user.get('profile').given_name}\n        userLastName={this.props.user.get('profile').family_name}\n        displayUserInitialsAsDefaultAvatar />;\n  }\n\n  _renderImpersonatedUser() {\n    if (! this.props.impersonate) {\n      return null;\n    }\n\n    const classes = classnames(styles.UserInfo_container_user_img,\n        styles.__impersonated,\n        testClass('impersonated-user-picture'));\n    return <AdultPicture src={this.props.impersonate.avatarUrl}\n        className={classes}\n        gender={this.props.impersonate.gender}\n        userFirstName={this.props.impersonate.givenName}\n        userLastName={this.props.impersonate.familyName}\n        displayUserInitialsAsDefaultAvatar />;\n  }\n\n  render() {\n    const { havePrivilegesLoaded } = this.props;\n    if (! havePrivilegesLoaded()) {\n      return null;\n    }\n\n    const classes = classnames(styles.UserInfo, {\n      [styles.__impersonating]: this.props.impersonate,\n      [styles.__open]: this.state.isDropdownOpen,\n    });\n\n    return <DropdownBox.Container className={classes}\n        onClickOutside={() => this.setState({ isDropdownOpen: false })}>\n      <div className={classnames(styles.UserInfo_container, testClass('header-user-dropdown'))}\n          onClick={(e) => this._toggleDropdown(e)}>\n        <div className={classnames(styles.UserInfo_container_expand)}>\n          <Icon id=\"chevron-small-down\" />\n        </div>\n        <div className={classnames(styles.UserInfo_container_user)}>\n          {this._renderUser()}\n          {this._renderImpersonatedUser()}\n        </div>\n      </div>\n      {this._renderDropdown()}\n      {this._renderImpersonateDialog()}\n    </DropdownBox.Container>;\n  }\n}\n\nUserInfo.propTypes = {\n  router: PropTypes.any.isRequired,\n  routes: PropTypes.array.isRequired,\n  havePrivilegesLoaded: PropTypes.func.isRequired,\n  postImpersonate: PropTypes.func,\n  token: PropTypes.string,\n  impersonate: PropTypes.object,\n  privileges: PropTypes.object,\n  hasUnimpersonated: PropTypes.bool.isRequired,\n  user: PropTypes.object,\n  canImpersonate: PropTypes.bool,\n  hasImpersonateFailed: PropTypes.bool.isRequired,\n  triggerSignInRedirect: PropTypes.func.isRequired,\n  triggerSignOutRedirect: PropTypes.func.isRequired,\n};\n\nfunction mapStateToProps(state) {\n  const postedImpersonate = state.get('impersonate').get('postedImpersonate').get('impersonate');\n  return {\n    arePrivilegesLoaded: state.get('privileges').items,\n    user: state.get('singleSignOn').get('user'),\n    canImpersonate: PrivilegeChecker.hasPrivilege(state, Config.get('impersonatePermission')),\n    hasUnimpersonated: !! (postedImpersonate && (postedImpersonate.get('error') || postedImpersonate.get('data'))),\n    hasImpersonateFailed: !! (postedImpersonate && postedImpersonate.get('error')),\n    token: state.get('singleSignOn').get('user').get('id_token'),\n  };\n}\n\nfunction mapDispatchToProps(dispatch) {\n  return Object.assign({},\n    bindActionCreators(privilegesActions, dispatch),\n    bindActionCreators(impersonateActions, dispatch),\n    bindActionCreators(ssoActions, dispatch)\n  );\n}\n\nexport default connect(mapStateToProps, mapDispatchToProps)(UserInfo);\n"]}