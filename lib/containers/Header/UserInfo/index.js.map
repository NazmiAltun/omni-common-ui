{"version":3,"sources":["containers/Header/UserInfo/index.jsx"],"names":["require","LOGOUT_POPUP_TITLE","LOGOUT_POPUP_MSG","UserInfo","props","state","isDropdownOpen","isShowImpersonate","_checkImpersonation","hasImpersonateFailed","setState","hasUnimpersonated","_redirectToPortal","event","preventDefault","confirm","setting","movable","transition","labels","ok","cancel","message","title","onok","router","setRouteLeaveHook","_getCurrentRoute","triggerSignOutRedirect","show","routes","length","url","get","window","location","reload","postImpersonate","undefined","token","impersonateData","evt","stopPropagation","_closeImpersonateDialog","_handleImpersonateSuccess","canImpersonate","impersonate","_onSwitchBackClicked","_showImpersonateDialog","UserInfo_features","_renderImpersonateOption","_onLogoutButtonClicked","classes","UserInfo_container_user_img","user","avatar_url","gender","given_name","family_name","__impersonated","avatarUrl","givenName","familyName","havePrivilegesLoaded","__impersonating","__open","UserInfo_container","e","_toggleDropdown","UserInfo_container_expand","UserInfo_container_user","_renderUser","_renderImpersonatedUser","_renderDropdown","_renderImpersonateDialog","propTypes","any","isRequired","array","func","string","object","privileges","bool","mapStateToProps","postedImpersonate","arePrivilegesLoaded","items","hasPrivilege","mapDispatchToProps","dispatch","Object","assign"],"mappings":"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","file":"index.js","sourcesContent":["import styles from './style.postcss';\n\nimport is from 'is_js';\nimport React, { PureComponent } from 'react';\nimport { bindActionCreators } from 'redux';\nimport classnames from 'classnames';\nimport connect from 'domain/connect';\nimport Dialog from 'components/Dialog';\nimport Impersonate, { actions as impersonateActions } from 'containers/Impersonate';\nimport { actions as ssoActions } from 'data/SingleSignOn';\nimport alertifyjs from 'alertifyjs';\nimport Config from 'domain/Config';\nimport AdultPicture from 'components/AdultPicture';\nimport testClass from 'domain/testClass';\nimport DropdownBox from 'components/DropdownBox';\nimport PrivilegeChecker from 'domain/PrivilegeChecker';\nimport { actions as privilegesActions } from 'containers/Privileges';\nimport Icon from 'components/Icon';\nimport PropTypes from 'prop-types';\n\nrequire('alertifyjs/build/css/alertify.css');\n\nconst LOGOUT_POPUP_TITLE =\n    'Log out';\nconst LOGOUT_POPUP_MSG =\n    'Are you sure you want to leave this page and lose unsaved changes?';\n\nclass UserInfo extends PureComponent {\n  constructor(props) {\n    super(props);\n    this.state = {\n      isDropdownOpen: false,\n      isShowImpersonate: false,\n    };\n    this._checkImpersonation(this.props);\n  }\n\n  componentWillReceiveProps(props) {\n    this._checkImpersonation(props);\n\n    if (props.hasImpersonateFailed) {\n      this.setState({ isShowImpersonate: false });\n    }\n  }\n\n  _checkImpersonation(props) {\n    if (props.hasUnimpersonated) {\n      this._redirectToPortal();\n    }\n  }\n\n  _onLogoutButtonClicked() {\n    event.preventDefault();\n    alertifyjs.confirm()\n    .setting({\n      movable: false,\n      transition: 'fade',\n      labels: {\n        ok: 'Leave',\n        cancel: 'Stay',\n      },\n      message: LOGOUT_POPUP_MSG,\n      title: LOGOUT_POPUP_TITLE,\n      onok: () => {\n        // don't show the unsaved changes warning\n        if (this.props.router) {\n          this.props.router.setRouteLeaveHook(this._getCurrentRoute(), null);\n        }\n        this.props.triggerSignOutRedirect();\n      },\n    }).show();\n  }\n\n  _getCurrentRoute() {\n    return this.props.routes[this.props.routes.length - 1];\n  }\n\n  _redirectToPortal() {\n    const url = Config.get('afterImpersonationRedirectTo');\n    if (is.url(url)) {\n      window.location = url;\n    } else {\n      window.location.reload();\n    }\n  }\n\n  _onSwitchBackClicked() {\n    this.props.postImpersonate(undefined, this.props.token);\n    this.setState({ impersonateData: undefined });\n  }\n\n  _toggleDropdown(evt) {\n    evt.preventDefault();\n    evt.stopPropagation();\n    this.setState({ isDropdownOpen: ! this.state.isDropdownOpen });\n  }\n\n  _showImpersonateDialog() {\n    this.setState({ isShowImpersonate: true, isDropdownOpen: false });\n  }\n\n  _closeImpersonateDialog() {\n    this.setState({ isShowImpersonate: false });\n  }\n\n  _handleImpersonateSuccess() {\n    this._redirectToPortal();\n  }\n\n  _renderImpersonateDialog() {\n    if (! this.state.isShowImpersonate) {\n      return null;\n    }\n\n    return <Dialog isOpen={this.state.isShowImpersonate} className={testClass('impersonate-dialog')}>\n      <Impersonate close={() => this._closeImpersonateDialog()}\n          success={() => this._handleImpersonateSuccess()} />\n    </Dialog>;\n  }\n\n  _renderImpersonateOption() {\n    const { canImpersonate } = this.props;\n    if (this.props.impersonate) {\n      return <DropdownBox.Item className={testClass('header-user-dropdown-switch-back')}\n          onClick={() => this._onSwitchBackClicked()}>\n        Switch Back\n      </DropdownBox.Item>;\n    }\n\n    return <DropdownBox.Item className={testClass('header-user-dropdown-switch-user')}\n        onClick={() => this._showImpersonateDialog()}\n        show={canImpersonate}>\n      Switch User\n    </DropdownBox.Item>;\n  }\n\n  _renderDropdown() {\n    return <DropdownBox className={styles.UserInfo_features} open={this.state.isDropdownOpen}>\n      {this._renderImpersonateOption()}\n      <DropdownBox.Item onClick={() => this._onLogoutButtonClicked()}>Log Out</DropdownBox.Item>\n    </DropdownBox>;\n  }\n\n  _renderUser() {\n    const classes = classnames(styles.UserInfo_container_user_img, testClass('user-picture'));\n    return <AdultPicture className={classes}\n        src={this.props.user.get('profile').avatar_url}\n        gender={this.props.user.get('profile').gender}\n        userFirstName={this.props.user.get('profile').given_name}\n        userLastName={this.props.user.get('profile').family_name}\n        displayUserInitialsAsDefaultAvatar />;\n  }\n\n  _renderImpersonatedUser() {\n    if (! this.props.impersonate) {\n      return null;\n    }\n\n    const classes = classnames(styles.UserInfo_container_user_img,\n        styles.__impersonated,\n        testClass('impersonated-user-picture'));\n    return <AdultPicture src={this.props.impersonate.avatarUrl}\n        className={classes}\n        gender={this.props.impersonate.gender}\n        userFirstName={this.props.impersonate.givenName}\n        userLastName={this.props.impersonate.familyName}\n        displayUserInitialsAsDefaultAvatar />;\n  }\n\n  render() {\n    const { havePrivilegesLoaded } = this.props;\n    if (! havePrivilegesLoaded()) {\n      return null;\n    }\n\n    const classes = classnames(styles.UserInfo, {\n      [styles.__impersonating]: this.props.impersonate,\n      [styles.__open]: this.state.isDropdownOpen,\n    });\n\n    return <DropdownBox.Container className={classes}\n        onClickOutside={() => this.setState({ isDropdownOpen: false })}>\n      <div className={classnames(styles.UserInfo_container, testClass('header-user-dropdown'))}\n          onClick={(e) => this._toggleDropdown(e)}>\n        <div className={classnames(styles.UserInfo_container_expand)}>\n          <Icon id=\"chevron-small-down\" />\n        </div>\n        <div className={classnames(styles.UserInfo_container_user)}>\n          {this._renderUser()}\n          {this._renderImpersonatedUser()}\n        </div>\n      </div>\n      {this._renderDropdown()}\n      {this._renderImpersonateDialog()}\n    </DropdownBox.Container>;\n  }\n}\n\nUserInfo.propTypes = {\n  router: PropTypes.any.isRequired,\n  routes: PropTypes.array.isRequired,\n  havePrivilegesLoaded: PropTypes.func.isRequired,\n  postImpersonate: PropTypes.func,\n  token: PropTypes.string,\n  impersonate: PropTypes.object,\n  privileges: PropTypes.object,\n  hasUnimpersonated: PropTypes.bool.isRequired,\n  user: PropTypes.object,\n  canImpersonate: PropTypes.bool,\n  hasImpersonateFailed: PropTypes.bool.isRequired,\n  triggerSignOutRedirect: PropTypes.func.isRequired,\n};\n\nfunction mapStateToProps(state) {\n  const postedImpersonate = state.get('impersonate').get('postedImpersonate').get('impersonate');\n  return {\n    arePrivilegesLoaded: state.get('privileges').items,\n    user: state.get('singleSignOn').get('user'),\n    canImpersonate: PrivilegeChecker.hasPrivilege(state, Config.get('impersonatePermission')),\n    hasUnimpersonated: !! (postedImpersonate && (postedImpersonate.get('error') || postedImpersonate.get('data'))),\n    hasImpersonateFailed: !! (postedImpersonate && postedImpersonate.get('error')),\n    token: state.get('singleSignOn').get('user').get('id_token'),\n  };\n}\n\nfunction mapDispatchToProps(dispatch) {\n  return Object.assign({},\n    bindActionCreators(privilegesActions, dispatch),\n    bindActionCreators(impersonateActions, dispatch),\n    bindActionCreators(ssoActions, dispatch)\n  );\n}\n\nexport default connect(mapStateToProps, mapDispatchToProps)(UserInfo);\n"]}